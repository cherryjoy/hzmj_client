TableBottom = {}

function TableBottom:Start( )
    self.IsInit = false
    self.PlayNum = 0
    self.LeftNum = 0

    Client.TableChooseCard = Client.TableChooseCard + {self, TableBottom.ChooseCard}
    Client.TablePlayCardEnd = Client.TablePlayCardEnd + {self, TableBottom.PlayCardEnd}
end

function TableBottom:OnDestroy( )
    Client.TableChooseCard = Client.TableChooseCard - {self,TableBottom.ChooseCard}
    Client.TablePlayCardEnd = Client.TablePlayCardEnd - {self, TableBottom.PlayCardEnd}
end

-- 最后一张为所发的牌
function TableBottom:CardInfoSync(handcard)
    self.HandCardNum = #handcard
    self.handCard = handcard
    for i = 1, self.HandCardNum do
        local card = handcard[i]
        LuaDebug.Log("card.type_id: "..card.type_id..", card.code_id: "..card.code_id)
        local ref = nil
        if not self.IsInit then
            if i == #handcard then
                ref = LuaUIViewCtr.OpenUINotLoseNest("MJTable/MyCard",self.CardNew)
                ref.gameObject:set_name("MyCard")
                ref.Message:target(ref.gameObject)
            else
                ref = LuaUIViewCtr.OpenUINotLoseNest("MJTable/MyCard",self.Grid:get_gameObject())
                ref.gameObject:set_name("MyCard")
                ref.Message:target(ref.gameObject)
            end
            self["Card"..i] = ref
        else
            ref = self["Card"..i]
        end

        ref.Init(ref, card, i)

        if i == self.HandCardNum then
            ref.Shinning:set_enabled(true)
            ref.gameObject:get_transform():set_localPosition(LuaVector3.Create(768, 0, 0))
        end
    end

    if not self.IsInit then
        self.IsInit = true
    end

    self.Grid:Reposition()
end

function TableBottom:LeftCardSync(owncards)
    if owncards.pengcard ~= nil then
        for i = 1, #(owncards.pengcard) do
            local card = owncards.pengcard[i]
            for num = 1, 3 do
                TableBottom.SetLeftCard(self, card)
            end
        end
    end

    --gangcardm gangcarda
    if owncards.gangcardm ~= nil then
        for i = 1, #(owncards.gangcardm) do
            local card = owncards.gangcardm[i]
            for num = 1, 4 do
                TableBottom.SetLeftCard(self, card)
            end
        end
    end

    if owncards.gangcarda ~= nil then
        for i = 1, #(owncards.gangcarda) do
            local card = owncards.gangcarda[i]
            for num = 1, 4 do
                TableBottom.SetLeftCard(self, card)
            end
        end
    end

    self.LeftCardGrid:Reposition()
end

function TableBottom:SetLeftCard(card)
    LuaDebug.Log("left card, type: "..card.type_id..", id: "..card.code_id)
    local ref = LuaUIViewCtr.OpenUINotLoseNest("MJTable/PengCard",self.LeftCardGrid:get_gameObject())
    local spriteName = MJTableCtrl.GetLeftCardSprite(card)
    ref.Card:set_spriteName(spriteName)
    ref.Card:MakePixelPerfectWithSizeInAtlas()

    self.LeftNum = self.LeftNum + 1
end

function TableBottom:ChooseCard(i)
    if self.lastIndex ~= nil and self.lastIndex ~= i then
        -- 回归原位
        self["Card"..self.lastIndex].ResetPos(self["Card"..self.lastIndex])
        self.lastIndex = nil
    end

    if i == self.lastIndex then
        ClientSendMsg.SendPlayCard(i, self["Card"..i].card.type_id, self["Card"..i].card.code_id)
        --self["Card"..i].gameObject:SetActive(false)
        Client.BottomPlayCard:Do(self.roleId, i, self["Card"..i].card, 0)

        self.lastIndex = nil
    else
        self.lastIndex = i

        self["Card"..i].SetPosUp(self["Card"..i])
    end
end

function TableBottom:PlayCard(i, card)
    if i ~= nil then
        self["Card"..i].Animation(self["Card"..i])
    end
end

function TableBottom:PlayCardEnd(i)
    local card = self["Card"..i].card

    local ref = LuaUIViewCtr.OpenUINotLoseNest("MJTable/PlayCard",self.PlayedCardsGrid:get_gameObject())
    if self.PlayNum > 7 then
        ref.Card:set_depth(5)
        ref.Back:set_depth(4)
    end

    local spriteName = MJTableCtrl.GetLeftCardSprite(card)
    ref.Card:set_spriteName(spriteName)
    ref.Card:MakePixelPerfectWithSizeInAtlas()

    self.PlayedCardsGrid:Reposition()

    self.toward:get_transform():SetParent(ref.Card:get_transform())
    self.toward:get_transform():set_localPosition(LuaVector3.Create(0, 0, 0))

    -- 整理手牌
    if i ~= self.HandCardNum then
        self["Card"..i].Init(self["Card"..i], self["Card"..self.HandCardNum].card, i)
        self.Grid:Reposition()
    end

    self["Card"..self.HandCardNum].gameObject:SetActive(false)
    self.PlayNum = self.PlayNum + 1

    LuaUIViewCtr.UIPanel["MJTableUI"].GetCard(LuaUIViewCtr.UIPanel["MJTableUI"], card)
end

function TableBottom:SetHeadInfo(info, toward)
    self.toward = toward
    self.roleId = info.roleid
    local ref = LuaUIViewCtr.OpenUINotLoseNest("MJTable/TableHead",self.HeadInfo)
    ref.gameObject:get_transform():set_localPosition(LuaVector3.Create(0, 0, 0))
    ref.Init(ref, info)
end

function TableBottom:GetCard(card)
    ref = self["Card"..self.HandCardNum]
    ref.gameObject:SetActive(true)
    --ref.gameObject:set_name("MyCard")
    --ref.Message:target(ref.gameObject)

    ref.Init(ref, card, self.HandCardNum)

    ref.Shinning:set_enabled(true)
    ref.gameObject:get_transform():set_localPosition(LuaVector3.Create(768, 0, 0))
end

function TableBottom:IsPengCard(card)
    local num = TableBottom.GetSameCardNum(self, card)
    if num >= 2 then
        return true
    end

    return false
end

function TableBottom:IsGangGard(card)
    local num = TableBottom.GetSameCardNum(self, card)
    if num >= 3 then
        return true
    end

    return false
end

function TableBottom:GetSameCardNum(card)
    local num = 0
    for i = 1, #(self.handCard) do
        local tmp = self.handCard[i]
        if card.type_id == tmp.type_id and card.code_id == tmp.code_id then
            num = num + 1
        end
    end

    return num
end
