TableLeft = {}

function TableLeft:Start( )
    TableLeft.Clear(self)

    Client.DeleteCard = Client.DeleteCard + {self, TableLeft.DeleteCard}
end

function TableLeft:OnDestroy( )
    Client.DeleteCard = Client.DeleteCard - {self, TableLeft.DeleteCard}
end

function TableLeft:Clear()
    self.PlayNum = 0
    self.LeftNum = 0
    self.handCard = {}
end

function TableLeft:CardInfoSync(handnum)
    for i = 1, handnum do
        local ref = LuaUIViewCtr.OpenUINotLoseNest("MJTable/LeftCard",self.Grid:get_gameObject())
        ref.gameObject:set_name("LeftCard")
        ref.Back:set_depth(i + 2)

        self.handCard[i] = ref
    end

    self.Grid:Reposition()
end

function TableLeft:LeftCardSync(owncards)
    if owncards.pengcard ~= nil then
        for i = 1, #(owncards.pengcard) do
            local card = owncards.pengcard[i]
            for num = 1, 3 do
                TableLeft.SetLeftCard(self, card)
            end
        end
    end

    --gangcardm gangcarda
    if owncards.gangcardm ~= nil then
        for i = 1, #(owncards.gangcardm) do
            local card = owncards.gangcardm[i]
            for num = 1, 4 do
                TableLeft.SetLeftCard(self, card)
            end
        end
    end

    if owncards.gangcarda ~= nil then
        for i = 1, #(owncards.gangcarda) do
            local card = owncards.gangcarda[i]
            for num = 1, 4 do
                TableLeft.SetLeftCard(self, card)
            end
        end
    end

    if owncards.gangcardg ~= nil then
        for i = 1, #(owncards.gangcardg) do
            local card = owncards.gangcardg[i]
            for num = 1, 4 do
                TableLeft.SetLeftCard(self, card)
            end
        end
    end

    TableLeft.LeftCardReposition(self)
end

function TableLeft:SetLeftCard(card)
    LuaDebug.Log("left card, type: "..card.type_id..", id: "..card.code_id)
    local ref = LuaUIViewCtr.OpenUINotLoseNest("MJTable/LeftPengCard",self.LeftCardGrid:get_gameObject())
    local spriteName = MJTableCtrl.GetLeftRightCardSprite(card)
    ref.Card:set_spriteName(spriteName)
    ref.Card:MakePixelPerfectWithSizeInAtlas()

    ref.Card:set_depth(3 + self.LeftNum)
    ref.Back:set_depth(2 + self.LeftNum)

    self.LeftNum = self.LeftNum + 1
end

function TableLeft:LeftCardReposition()
    local pos = self.LeftCardGrid:get_transform():get_localPosition()
    local posY = (self.LeftNum -1)*26 -160
    self.LeftCardGrid:get_transform():set_localPosition(LuaVector3.Create(pos:x(), posY, pos:z()))
    self.LeftCardGrid:Reposition()
end

function TableLeft:HandlePlayCard(i, card)
    --LuaDebug.Log("play card, type: "..card.type_id..", id: "..card.code_id)
    local ref = LuaUIViewCtr.OpenUINotLoseNest("MJTable/LeftPlayCard",self.PlayedCardsGrid:get_gameObject())
    local spriteName = MJTableCtrl.GetLeftRightCardSprite(card)
    ref.Card:set_spriteName(spriteName)
    ref.Card:MakePixelPerfectWithSizeInAtlas()

    local row = math.floor(self.PlayNum / 6)
    local colum = self.PlayNum % 6

    local pos = ref.Card:get_transform():get_localPosition()
    ref.Card:get_transform():set_localPosition(LuaVector3.Create(pos:x()-row*50, pos:y()-colum*31, pos:z()))

    ref.Card:set_depth(ref.Card:get_depth() + colum*2)
    ref.Back:set_depth(ref.Back:get_depth() + colum*2)

    self.toward:get_transform():SetParent(ref.Card:get_transform())
    self.toward:get_transform():set_localPosition(LuaVector3.Create(0, 0, 0))

    self.PlayNum = self.PlayNum + 1
    self.lastCard = ref

    if self.GetCard:get_activeSelf() then
        self.GetCard:SetActive(false)
    else
        TableLeft.RemoveHandCard(self, 1)
    end
end

function TableLeft:PlayCardEnd()

end

function TableLeft:SetHeadInfo(info, toward)
    self.toward = toward
    self.roleId = info.roleid
    local ref = LuaUIViewCtr.OpenUINotLoseNest("MJTable/TableHead",self.HeadInfo)
    ref.gameObject:get_transform():set_localPosition(LuaVector3.Create(-420, 50, 0))
    ref.Init(ref, info)
end

function TableLeft:HandleGetCard(card)
    self.GetCard:SetActive(true)
end

function TableLeft:DeleteCard(srcRoleId)
    if self.roleId == srcRoleId then
        self.lastCard.Card:get_gameObject():Destroy1()
        self.PlayNum = self.PlayNum - 1
    end
end

function TableLeft:HandlePengCard(card)
    -- 添加碰牌
    for num = 1, 3 do
        TableLeft.SetLeftCard(self, card)
    end

    TableLeft.LeftCardReposition(self)

    --减少手牌
    local num = #(self.handCard)
    LuaDebug.Log("num: "..num)
    TableLeft.RemoveHandCard(self, 2)
end

function TableLeft:HandleGangCard(card, gangType)
    -- 添加杠牌
    local total = 0
    local numTotal = 0
    if gangType == enumCARD_GANG_TYPE.CARD_GANG_M_TYPE then
        total = 4
        numTotal = 3
    elseif gangType == enumCARD_GANG_TYPE.CARD_GANG_A_TYPE then
        total = 4
        numTotal = 4
    elseif gangType == enumCARD_GANG_TYPE.CARD_GANG_G_TYPE then
        total = 1
        numTotal = 1
    end
    for num = 1, total do
        TableLeft.SetLeftCard(self, card)
    end

    TableLeft.LeftCardReposition(self)

    -- 减少手牌
    TableLeft.RemoveHandCard(self, numTotal)
end

function TableLeft:RemoveHandCard(numTotal)
    for num = 1, numTotal do
        local ref = self.handCard[#(self.handCard)]
        table.remove(self.handCard)
        ref.LeftCard:Destroy1()
    end
end

function TableLeft:TableClear(roleId)
    TableLeft.Clear(self)
end
