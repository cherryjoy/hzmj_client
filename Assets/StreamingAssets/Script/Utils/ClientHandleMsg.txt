require("NetOpcodes/NetOpcodes_S2C")
require("NetOpcodes/NetOpcodes_C2S")
--require "NetProtocol/NP_BaseType"
require("NetProtocol/LuaProto")
--require("NetProtocol/NP_ServerClient")
require("Utils/Client")
require("Utils/RoleInfo")
--require("FairyUI/Client.RoleInfo.FairyMgr")
--require ("GameBattleSelect/GameBattleMapMgr")
--require "Corps/CorpsManager"
--require "ChatUI/ChatManager"
--require "GemStoneUI/GemStoneMgr"
--require "ChatUI/RoleInfoCtrl"
require("NetProtocol/module_05_core")

--require("SceneControl/KingroadActivity")

--------------------------------------
ClientHandleMsg = {}
--msgNameTable =  Util.TableInvert(NetOpcodes_S2C)
function ClientHandleMsg.Handle(msgId,data,dataLength)
    -- if NetOpcodes_S2C.S2C_CHEAT_CHECK ~= msgId then
         LuaDebug.Log("recv msgID: " .. msgId)
    -- end
    local handleFunc = HandleFuncs[msgId]
    if handleFunc then
      handleFunc(data,dataLength)
    end
    Client.ServerMsgGet:Do(msgId)
end
--------------------------------------

HandleFuncs = {}

HandleFuncs[enumMSGID_MODULE_05.ID_ROLE_RES] = function(data, dataLength)
    local pbMsg = LuaProto.deserialize(PBMsgRoleInfoRes, data, dataLength)
    LuaDebug.Log("roleName: "..pbMsg.RoleName)
    LuaDebug.Log("roleId: "..pbMsg.RoleID)

    PlayerPrefsEx.SetString("userName", pbMsg.RoleName)
    --PlayerPrefsEx.SetString("password",data.password)
    --PlayerPrefsEx.SetString("userId",data.userId .. "")
    Client.RoleInfo = pbMsg
    if Client.RoleInfo.sex == nil then   -- 1 为男性    2为女性
        Client.RoleInfo.sex = 2
    end

    LuaUIViewCtr.UIPanel["MainUI"] = LuaUIViewCtr.OpenUIHasBg("Home/MainUI")
    LuaUIViewCtr.UIPanel["MainUI"].Init(LuaUIViewCtr.UIPanel["MainUI"], pbMsg.RoleName, pbMsg.RoleID, pbMsg.integral, pbMsg.imageurl)

    Client.LoginSuccess:Do()

    -- 如果上次是在房间中退出的，则加入房间
    if pbMsg.room_pass ~= nil then
        ClientSendMsg.SendEnterRoom(Client.RoleInfo.RoleID, pbMsg.room_pass)
    end
end

HandleFuncs[NetOpcodes_S2C.S2C_SESSION_CREATED] = function (data,dataLength)
    Client.ClientInfo.SessionID = LuaProto.deserializeLong(data,dataLength)
    -- Client.ConnectSuccess:Do()
    ClientInfo.isFirstLogin = false
    ClientInfo.ServerTime.SetTimer()
    Client.SessionCreated:Do()
    Client.NetState = EClientNetWorkState.NORMAL
end

HandleFuncs[NetOpcodes_S2C.S2C_SERVER_TIME] = function (data,dataLength)
    local ServerTime = LuaProto.deserialize(S2CServerTime,data,dataLength)
    if ServerTime.time == nil then
        return
    end
    ClientInfo.ServerTime.TestNetWorkDelta(ServerTime)
    if not ClientInfo.isFirstLogin then
        Client.ConnectSuccess:Do()
        ClientInfo.isFirstLogin = true
    end
end

HandleFuncs[NetOpcodes_S2C.S2C_ERROR_CODE] = function (data,dataLength)
    local i = LuaProto.deserializeInt(data,dataLength)
    ----------------display in tishicentre-----------------
    require("Utils/TishiCentre")
    TishiCentre.DisplayServerErrorMsg(i)
    TaskMgr.isAuto = false
end

HandleFuncs[NetOpcodes_S2C.S2C_AUTH] = function (data,dataLength)
    local data=LuaProto.deserialize(S2CPassport,data,dataLength)

    PlayerPrefsEx.SetString("userName",data.userName)
    PlayerPrefsEx.SetString("password",data.password)
    PlayerPrefsEx.SetString("userId",data.userId .. "")

    Client.LoginSuccess:Do()
end

HandleFuncs[enumMSGID_MODULE_05.ID_SERVER_AUTO_CLOSE_SOCKET_NOTICE] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgServerAutoCloseSocketNotice, data, dataLength)

    LuaDebug.Log("cloes socket, reasion: "..data.reason)
    Client.NetCloseSocket(data.reason)
end

HandleFuncs[enumMSGID_MODULE_05.ID_ERROR_CODE_NOTICE] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgErrorCodeNotice, data, dataLength)

    LuaDebug.Log("errcode: "..data.err_code)
    LuaDebug.Log("err_type: "..data.err_type)
    -- ERR_PLAYER_SESSION_FAIL -10000，需要重新登录

    for i = 1, #data.err_para do
        LuaDebug.Log("err_para "..i.." : "..data.err_para[i])
    end

    if data.err_code == -10000 then
        local ref = LuaMessageBox.ShowSingle(Text.Disconnected, nil, Text.Confirm, self)
        ref.button_Single:SetActive(false)
    end
end

HandleFuncs[enumMSGID_MODULE_05.ID_ROLE_SESSION_ID_NOTICE] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgRoleSessionIdNotice, data, dataLength)

    LuaDebug.Log("session_id: ".. long_to_id(data.session_id))

    PingManager.get_Instance():sessionId(long_to_id(data.session_id))
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_ROOM_CREATE_RES] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgCreateRoomRes, data, dataLength)

    LuaDebug.Log("passwd: "..data.passwd..", amount: "..data.amount..", horse: "..data.horse..", add: "..data.addition)
    --[[
    if LuaUIViewCtr.UIPanel["MJTableUI"] == nil then
        local ref = LuaUIViewCtr.OpenUIHasBg("MJTable/MJTable")
        --data.addition
        local roleList = {}
        local info = {}
        info.rolename = "111111"
        info.integral = 0
        info.host = 1
        info.makers = 1
        table.insert(roleList, info)
        ref.Init(ref, data.passwd, data.amount, data.horse, 5, 0, roleList)
        LuaUIViewCtr.UIPanel["MJTableUI"] = ref
    end
    --]]
    ClientSendMsg.SendEnterRoom(Client.RoleInfo.RoleID, data.passwd)
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_ROOM_ENTER_RES] = function(data,dataLength)
    local data = LuaProto.deserialize(PBMsgEnterRoomRes, data, dataLength)
    LuaDebug.Log("enter room: "..data.passwd)
    if LuaUIViewCtr.UIPanel["MJTableUI"] == nil then
        local ref = LuaUIViewCtr.OpenUIHasBg("MJTable/MJTable")
        LuaUIViewCtr.UIPanel["MJTableUI"] = ref
        Client.RoleInfo.Used = data.used
        Client.RoleInfo.Amount = data.amount
        Client.RoleInfo.RestCard = 112
        ClientSendMsg.SendReadyRoom()
        LuaUIViewCtr.UIPanel["MJTableUI"].Init(LuaUIViewCtr.UIPanel["MJTableUI"], data.passwd, data.horse, data.addition, data.rolelist)
        LuaUIViewCtr.UIPanel["MJTableUI"].SetJuShuPaiShu(LuaUIViewCtr.UIPanel["MJTableUI"])

        -- 关闭主界面
        LuaUIViewCtr.UIPanel["MainUI"].gameObject:SetActive(false)
    end

    LuaUIViewCtr.UIPanel["MJTableUI"].EnterRoomSync(LuaUIViewCtr.UIPanel["MJTableUI"], data.rolelist)
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_READY_RES] = function(data,dataLength)
    local data = LuaProto.deserialize(PBMsgReadyRes, data, dataLength)

    Client.RoleInfo.Used = data.used
    Client.RoleInfo.RestCard = 112

    if data.roleid == Client.RoleInfo.RoleID then
        Client.ResetToward:Do()
        Client.TableClear:Do()
    end

    LuaUIViewCtr.UIPanel["MJTableUI"].SetJuShuPaiShu(LuaUIViewCtr.UIPanel["MJTableUI"])
    LuaUIViewCtr.UIPanel["MJTableUI"].GameReady(LuaUIViewCtr.UIPanel["MJTableUI"], data.rolestate)
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_ROOM_CARD_SYNC] = function(data, dataLength)
    local data = LuaProto.deserialize(PBRoomCardInfoSync, data, dataLength)

    --LuaDebug.Log("card num: "..#(data.owncards.handcard));
    LuaUIViewCtr.UIPanel["MJTableUI"].CardInfoSync(LuaUIViewCtr.UIPanel["MJTableUI"], data)
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_DELETE_ROOM_RES] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgGameDeleteRoomRes, data, dataLength)

    LuaDebug.Log("result: "..data.result)

    LuaUIViewCtr.UIPanel["MainUI"].gameObject:SetActive(true)

    LuaUIViewCtr.UIPanel["MJTableUI"].gameObject:Destroy1()
    LuaUIViewCtr.UIPanel["MJTableUI"] = nil
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_PLAY_CARD_RES] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgPlayCardRes, data, dataLength)

    LuaUIViewCtr.UIPanel["MJTableUI"].HandlePlayCard(LuaUIViewCtr.UIPanel["MJTableUI"], data.roleid, data.index, data.card, data.result)
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_GET_CARD_RES] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgGameGetCardRes, data, dataLength)

    LuaUIViewCtr.UIPanel["MJTableUI"].HandleGetCard(LuaUIViewCtr.UIPanel["MJTableUI"], data.roleid, data.card)
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_PENG_CARD_RES] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgPengCardRes, data, dataLength)

    LuaUIViewCtr.UIPanel["MJTableUI"].HandlePengCard(LuaUIViewCtr.UIPanel["MJTableUI"], data.roleid, data.index, data.card, data.srcid)
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_GANG_CARD_RES] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgGangCardRes, data, dataLength)

    LuaUIViewCtr.UIPanel["MJTableUI"].HandleGangCard(LuaUIViewCtr.UIPanel["MJTableUI"], data.roleid, data.index, data.card, data.state, data.srcid)
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_PASS_CARD_RES] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgGamePassCardRes, data, dataLength)

    LuaUIViewCtr.UIPanel["MJTableUI"].HandleGuoCard(LuaUIViewCtr.UIPanel["MJTableUI"])
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_WIN_GAME_RES] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgWinGameRes, data, dataLength)
    LuaDebug.Log("data.count: "..data.count)
    LuaDebug.Log("data.card: "..#(data.card))
    LuaUIViewCtr.UIPanel["MJTableUI"].HandleWinGame(LuaUIViewCtr.UIPanel["MJTableUI"], data.roleid, data.count, data.card)
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_WIN_CARD_RES] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgGameWinCardRes, data, dataLength)

    LuaUIViewCtr.UIPanel["MJTableUI"].HandleTingCard(LuaUIViewCtr.UIPanel["MJTableUI"], data.card)
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_RESULT_RES] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgGameResultRes, data, dataLength)

    LuaUIViewCtr.UIPanel["MJTableUI"].HandleGameResult(LuaUIViewCtr.UIPanel["MJTableUI"], data)
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_BALANCE_RES] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgGameBalanceRes, data, dataLength)

    LuaUIViewCtr.UIPanel["MJTableUI"].HandleGameBalance(LuaUIViewCtr.UIPanel["MJTableUI"], data.balances)
end
