require("NetOpcodes/NetOpcodes_S2C")
require("NetOpcodes/NetOpcodes_C2S")
--require "NetProtocol/NP_BaseType"
require("NetProtocol/LuaProto")
--require("NetProtocol/NP_ServerClient")
require("Utils/Client")
require("Utils/RoleInfo")
--require("FairyUI/Client.RoleInfo.FairyMgr")
--require ("GameBattleSelect/GameBattleMapMgr")
--require "Corps/CorpsManager"
--require "ChatUI/ChatManager"
--require "GemStoneUI/GemStoneMgr"
--require "ChatUI/RoleInfoCtrl"
require("NetProtocol/module_05_core")

--require("SceneControl/KingroadActivity")

--------------------------------------
ClientHandleMsg = {}
--msgNameTable =  Util.TableInvert(NetOpcodes_S2C)
function ClientHandleMsg.Handle(msgId,data,dataLength)
    -- if NetOpcodes_S2C.S2C_CHEAT_CHECK ~= msgId then
         LuaDebug.Log("recv msgID: " .. msgId)
    -- end
    local handleFunc = HandleFuncs[msgId]
    if handleFunc then
      handleFunc(data,dataLength)
    end
    Client.ServerMsgGet:Do(msgId)
end
--------------------------------------

HandleFuncs = {}

HandleFuncs[enumMSGID_MODULE_05.ID_ROLE_RES] = function(data, dataLength)
    local pbMsg = LuaProto.deserialize(PBMsgRoleInfoRes, data, dataLength)
    LuaDebug.Log("roleName: "..pbMsg.RoleName)
    LuaDebug.Log("roleId: "..pbMsg.RoleID)

    PlayerPrefsEx.SetString("userName", pbMsg.RoleName)
    --PlayerPrefsEx.SetString("password",data.password)
    --PlayerPrefsEx.SetString("userId",data.userId .. "")
    Client.RoleInfo = {}
    Client.RoleInfo.RoleID = pbMsg.RoleID

    local ref = LuaUIViewCtr.OpenUIHasBg("Home/MainUI")
    ref.Init(ref, pbMsg.RoleName, pbMsg.RoleID, pbMsg.room_pass)

    Client.LoginSuccess:Do()

    -- 如果上次是在房间中退出的，则加入房间
    ClientSendMsg.SendEnterRoom(Client.RoleInfo.RoleID, pbMsg.room_pass)
end

HandleFuncs[NetOpcodes_S2C.S2C_SESSION_CREATED] = function (data,dataLength)
    Client.ClientInfo.SessionID = LuaProto.deserializeLong(data,dataLength)
    -- Client.ConnectSuccess:Do()
    ClientInfo.isFirstLogin = false
    ClientInfo.ServerTime.SetTimer()
    Client.SessionCreated:Do()
    Client.NetState = EClientNetWorkState.NORMAL
end

HandleFuncs[NetOpcodes_S2C.S2C_SERVER_TIME] = function (data,dataLength)
    local ServerTime = LuaProto.deserialize(S2CServerTime,data,dataLength)
    if ServerTime.time == nil then
        return
    end
    ClientInfo.ServerTime.TestNetWorkDelta(ServerTime)
    if not ClientInfo.isFirstLogin then
        Client.ConnectSuccess:Do()
        ClientInfo.isFirstLogin = true
    end
end

HandleFuncs[NetOpcodes_S2C.S2C_ERROR_CODE] = function (data,dataLength)
    local i = LuaProto.deserializeInt(data,dataLength)
    ----------------display in tishicentre-----------------
    require("Utils/TishiCentre")
    TishiCentre.DisplayServerErrorMsg(i)
    TaskMgr.isAuto = false
end

HandleFuncs[NetOpcodes_S2C.S2C_AUTH] = function (data,dataLength)
    local data=LuaProto.deserialize(S2CPassport,data,dataLength)

    PlayerPrefsEx.SetString("userName",data.userName)
    PlayerPrefsEx.SetString("password",data.password)
    PlayerPrefsEx.SetString("userId",data.userId .. "")

    Client.LoginSuccess:Do()
end

HandleFuncs[enumMSGID_MODULE_05.ID_ERROR_CODE_NOTICE] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgErrorCodeNotice, data, dataLength)

    LuaDebug.Log("errcode: "..data.err_code)
    LuaDebug.Log("err_type: "..data.err_type)
    for i = 1, #data.err_para do
        LuaDebug.Log("err_para "..i.." : "..data.err_para[i])
    end
end

HandleFuncs[enumMSGID_MODULE_05.ID_ROLE_SESSION_ID_NOTICE] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgRoleSessionIdNotice, data, dataLength)

    LuaDebug.Log("session_id: ".. long_to_id(data.session_id))

    PingManager.get_Instance():sessionId(long_to_id(data.session_id))
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_ROOM_CREATE_RES] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgCreateRoomRes, data, dataLength)

    LuaDebug.Log("passwd: "..data.passwd..", amount: "..data.amount..", horse: "..data.horse..", add: "..data.addition)
    --[[
    if LuaUIViewCtr.UIPanel["MJTableUI"] == nil then
        local ref = LuaUIViewCtr.OpenUIHasBg("MJTable/MJTable")
        --data.addition
        local roleList = {}
        local info = {}
        info.rolename = "111111"
        info.integral = 0
        info.host = 1
        info.makers = 1
        table.insert(roleList, info)
        ref.Init(ref, data.passwd, data.amount, data.horse, 5, 0, roleList)
        LuaUIViewCtr.UIPanel["MJTableUI"] = ref
    end
    --]]
    ClientSendMsg.SendEnterRoom(Client.RoleInfo.RoleID, data.passwd)
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_ROOM_ENTER_RES] = function(data,dataLength)
    local data = LuaProto.deserialize(PBMsgEnterRoomRes, data, dataLength)
    LuaDebug.Log("enter room: "..data.passwd)
    if LuaUIViewCtr.UIPanel["MJTableUI"] == nil then
        local ref = LuaUIViewCtr.OpenUIHasBg("MJTable/MJTable")
        LuaUIViewCtr.UIPanel["MJTableUI"] = ref
        ClientSendMsg.SendReadyRoom()
        LuaUIViewCtr.UIPanel["MJTableUI"].Init(LuaUIViewCtr.UIPanel["MJTableUI"], data.passwd, data.amount, data.horse, 5, data.used, data.rolelist)
    end

    --data.addition
    LuaUIViewCtr.UIPanel["MJTableUI"].EnterRoomSync(LuaUIViewCtr.UIPanel["MJTableUI"], data.rolelist)
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_READY_RES] = function(data,dataLength)
    local data = LuaProto.deserialize(PBMsgReadyRes, data, dataLength)

end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_ROOM_CARD_SYNC] = function(data, dataLength)
    local data = LuaProto.deserialize(PBRoomCardInfoSync, data, dataLength)

    --LuaDebug.Log("card num: "..#(data.owncards.handcard));
    LuaUIViewCtr.UIPanel["MJTableUI"].CardInfoSync(LuaUIViewCtr.UIPanel["MJTableUI"], data)
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_DELETE_ROOM_RES] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgGameDeleteRoomRes, data, dataLength)

    LuaDebug.Log("result: "..data.result)

    LuaUIViewCtr.UIPanel["MJTableUI"].gameObject:Destroy1()
    LuaUIViewCtr.UIPanel["MJTableUI"] = nil
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_PLAY_CARD_RES] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgPlayCardRes, data, dataLength)

    LuaUIViewCtr.UIPanel["MJTableUI"].PlayCard(LuaUIViewCtr.UIPanel["MJTableUI"], data.roleid, data.index, data.card, data.result)
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_GET_CARD_RES] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgGameGetCardRes, data, dataLength)

    LuaUIViewCtr.UIPanel["MJTableUI"].GetCard(LuaUIViewCtr.UIPanel["MJTableUI"], data.roleid, data.card)
end
