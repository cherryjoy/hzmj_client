require("NetOpcodes/NetOpcodes_S2C")
require("NetOpcodes/NetOpcodes_C2S")
--require "NetProtocol/NP_BaseType"
require("NetProtocol/LuaProto")
--require("NetProtocol/NP_ServerClient")
require("Utils/Client")
require("Utils/RoleInfo")
--require("FairyUI/Client.RoleInfo.FairyMgr")
--require ("GameBattleSelect/GameBattleMapMgr")
--require "Corps/CorpsManager"
--require "ChatUI/ChatManager"
--require "GemStoneUI/GemStoneMgr"
--require "ChatUI/RoleInfoCtrl"
require("NetProtocol/module_05_core")

--require("SceneControl/KingroadActivity")

--------------------------------------
ClientHandleMsg = {}
--msgNameTable =  Util.TableInvert(NetOpcodes_S2C)
function ClientHandleMsg.Handle(msgId,data,dataLength)
    -- if NetOpcodes_S2C.S2C_CHEAT_CHECK ~= msgId then
         LuaDebug.Log("msgID: " .. msgId)
    -- end
    local handleFunc = HandleFuncs[msgId]
    if handleFunc then
      handleFunc(data,dataLength)
    end
    Client.ServerMsgGet:Do(msgId)
end
--------------------------------------

HandleFuncs = {}

HandleFuncs[enumMSGID_MODULE_05.ID_ROLE_RES] = function(data, dataLength)
    local pbMsg = LuaProto.deserialize(PBMsgRoleInfoRes, data, dataLength)
    LuaDebug.Log("roleName: "..pbMsg.RoleName)
    LuaDebug.Log("roleId: "..pbMsg.RoleID)

    PlayerPrefsEx.SetString("userName", pbMsg.RoleName)
    --PlayerPrefsEx.SetString("password",data.password)
    --PlayerPrefsEx.SetString("userId",data.userId .. "")
    Client.RoleInfo = {}
    Client.RoleInfo.RoleID = pbMsg.RoleID

    local ref = LuaUIViewCtr.OpenUIHasBg("Home/MainUI")
    ref.Init(ref, pbMsg.RoleName, pbMsg.RoleID, 99)
end

HandleFuncs[NetOpcodes_S2C.S2C_SESSION_CREATED] = function (data,dataLength)
    Client.ClientInfo.SessionID = LuaProto.deserializeLong(data,dataLength)
    -- Client.ConnectSuccess:Do()
    ClientInfo.isFirstLogin = false
    ClientInfo.ServerTime.SetTimer()
    Client.SessionCreated:Do()
    Client.NetState = EClientNetWorkState.NORMAL
end

HandleFuncs[NetOpcodes_S2C.S2C_SERVER_TIME] = function (data,dataLength)
    local ServerTime = LuaProto.deserialize(S2CServerTime,data,dataLength)
    if ServerTime.time == nil then
        return
    end
    ClientInfo.ServerTime.TestNetWorkDelta(ServerTime)
    if not ClientInfo.isFirstLogin then
        Client.ConnectSuccess:Do()
        ClientInfo.isFirstLogin = true
    end
end

HandleFuncs[NetOpcodes_S2C.S2C_ERROR_CODE] = function (data,dataLength)
    local i = LuaProto.deserializeInt(data,dataLength)
    ----------------display in tishicentre-----------------
    require("Utils/TishiCentre")
    TishiCentre.DisplayServerErrorMsg(i)
    TaskMgr.isAuto = false
end

HandleFuncs[NetOpcodes_S2C.S2C_AUTH] = function (data,dataLength)
    local data=LuaProto.deserialize(S2CPassport,data,dataLength)

    PlayerPrefsEx.SetString("userName",data.userName)
    PlayerPrefsEx.SetString("password",data.password)
    PlayerPrefsEx.SetString("userId",data.userId .. "")

    Client.LoginSuccess:Do()
end

HandleFuncs[enumMSGID_MODULE_05.ID_ERROR_CODE_NOTICE] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgErrorCodeNotice, data, dataLength)

    LuaDebug.Log("errcode: "..data.err_code)
end

HandleFuncs[enumMSGID_MODULE_05.ID_ROLE_SESSION_ID_NOTICE] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgRoleSessionIdNotice, data, dataLength)

    LuaDebug.Log("session_id: ".. long_to_id(data.session_id))

    PingManager.get_Instance():sessionId(long_to_id(data.session_id))
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_ROOM_CREATE_RES] = function(data, dataLength)
    local data = LuaProto.deserialize(PBMsgCreateRoomRes, data, dataLength)

    LuaDebug.Log("passwd: "..data.passwd..", amount: "..data.amount..", horse: "..data.horse..", add: "..data.addition)
    --local ref = LuaUIViewCtr.OpenUIHasBg("MJTable/MJTable")
    --ref.Init(ref, data.passwd, data.amount, data.horse, 1, 0)

    ClientSendMsg.SendEnterRoom(Client.RoleInfo.RoleID, data.passwd)
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_ROOM_ENTER_RES] = function(data,dataLength)
    local data = LuaProto.deserialize(PBMsgEnterRoomRes, data, dataLength)

    local ref = LuaUIViewCtr.OpenUIHasBg("MJTable/MJTable")
    ref.Init(ref, data.passwd, data.amount, data.horse, 1, data.used)

    ClientSendMsg.SendReadyRoom()
end

HandleFuncs[enumMSGID_MODULE_05.ID_GAME_READY_RES] = function(data,dataLength)
    local data = LuaProto.deserialize(PBMsgReadyRes, data, dataLength)
    
end
